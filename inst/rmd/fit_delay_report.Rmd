---
title: "Fit Delay Model Report"
output: 
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
params:
  model_number: "Model 1"
  analysis_folder: NULL
  model_results: NULL
  tacs_files: NULL
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
library(dplyr)
library(ggplot2)
library(knitr)
library(jsonlite)
theme_set(theme_light())

# Load configuration from standard location
config_path <- file.path(params$analysis_folder, "desc-kinfitroptions_config.json")
config <- NULL
if (file.exists(config_path)) {
  tryCatch({
    config <- jsonlite::fromJSON(config_path)
    cat("Loaded config from:", config_path, "\n")
  }, error = function(e) {
    cat("Warning: Could not load config file:", e$message, "\n")
  })
} else {
  cat("Config file not found at:", config_path, "\n")
}
```

# `r params$model_number`: Fit Delay Model Report

This report summarises the delay-fitting model results for the kinfitr analysis pipeline.

## Analysis Configuration

**Model:** `r params$model_number` - Fit Delay Model

**Analysis folder:** `r params$analysis_folder`

**Generated on:** `r format(Sys.time(), "%Y-%m-%d %H:%M:%S")`

## Delay Fitting Overview

The delay-fitting approach simultaneously estimates kinetic parameters and the timing delay between blood and tissue measurements. This accounts for:

- **Catheter delays**: Time for blood to travel through sampling lines
- **Processing delays**: Time between sampling and measurement
- **Regional delays**: Potential differences in tracer arrival times

```{r model-config}
# Extract model configuration for this specific model
model_config <- NULL
if (!is.null(config$Models)) {
  if (params$model_number == "Model 1") {
    model_config <- config$Models$Model1
  } else if (params$model_number == "Model 2") {
    model_config <- config$Models$Model2
  } else if (params$model_number == "Model 3") {
    model_config <- config$Models$Model3
  }
}

if (!is.null(model_config) && model_config$type == "Fit Delay") {
  cat("Delay-fitting model configuration found and applied.")
} else {
  cat("Delay-fitting model configuration not found or incomplete.")
}
```

## Model Parameters

```{r delay-params}
cat("Delay-fitting model estimates:")
cat("\n- Kinetic parameters (K1, k2, etc. depending on base model)")
cat("\n- Delay parameter (Δt): Timing offset in seconds/minutes")
cat("\n- vB: Blood volume fraction")
cat("\n- Base compartmental model parameters")
```

## Delay Estimation Results

```{r delay-results}
if (!is.null(params$model_results)) {
  cat("Delay-fitting model completed successfully.")
  # Add results summary here
} else {
  cat("Delay-fitting results not available.")
  cat("\nDelay fitting will produce:")
  cat("\n- Estimated delays for each TAC")
  cat("\n- Kinetic parameters corrected for delay")
  cat("\n- Improved model fits with delay correction")
}
```

## Estimated Delays

```{r delay-estimates}
cat("Delay estimates will show:")
cat("\n- Delay values (Δt) for each measurement")
cat("\n- Delay uncertainty estimates")
cat("\n- Regional variation in delays")
cat("\n- Subject-specific delay patterns")
```

## Model Fits with Delay Correction

```{r delay-fits, fig.height=8, fig.width=12}
cat("Delay-corrected model fits will include:")
cat("\n- Before/after delay correction comparison")
cat("\n- Improved TACs alignment")
cat("\n- Residuals analysis")
cat("\n- Goodness of fit improvement")
```

## Delay Distribution Analysis

```{r delay-distribution}
cat("Delay distribution analysis will show:")
cat("\n- Histogram of estimated delays")
cat("\n- Mean and variability of delays")
cat("\n- Outlier detection")
cat("\n- Physiological reasonableness assessment")
```

## Kinetic Parameters

```{r kinetic-params}
cat("Delay-corrected kinetic parameters:")
cat("\n- Parameter estimates with delay correction applied")
cat("\n- Comparison with non-delay-corrected results")
cat("\n- Parameter uncertainties")
cat("\n- Derived parameters (VT, BP, etc.)")
```

## Quality Control

```{r delay-qc}
cat("Delay-fitting quality control:")
cat("\n- Delays within physiologically reasonable range (0-60 seconds typical)")
cat("\n- Improved model fits compared to non-delay models")
cat("\n- Consistent delay estimates across similar conditions")
cat("\n- Parameter convergence and identifiability")
cat("\n- Residual patterns improvement")
```

## Model Comparison

```{r model-comparison}
cat("Comparison with non-delay models:")
cat("\n- AIC/BIC improvement with delay fitting")
cat("\n- Parameter estimate differences")
cat("\n- Goodness of fit metrics comparison")
cat("\n- Physiological plausibility of results")
```

## Next Steps

After reviewing this report:

1. **Verify delay estimates**: Check that delays are physiologically reasonable
2. **Assess model improvement**: Confirm better fits with delay correction
3. **Compare parameters**: Evaluate impact of delay correction on kinetic parameters
4. **Validate consistency**: Ensure consistent delays across similar measurements

## Session Information

```{r session-info}
sessionInfo()
```